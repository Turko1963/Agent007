<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentGPT Interface</title>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #343541;
            color: #ECECF1;
            font-family: system-ui, -apple-system, sans-serif;
        }
        
        .chatgpt-input {
            background-color: #40414F;
            border: 1px solid #565869;
            transition: all 0.2s ease;
        }
        
        .chatgpt-input:focus {
            border-color: #10A37F;
            outline: none;
            box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.2);
        }
        
        .result-block {
            background-color: #444654;
            border: 1px solid #565869;
        }

        .green-button {
            background-color: #10A37F;
        }

        .green-button:hover:not(:disabled) {
            background-color: #0F916F;
        }

        .green-text {
            color: #10A37F;
        }

        .message-block {
            transition: all 0.3s ease;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .thinking-dots::after {
            content: '...';
            animation: thinking 1.5s infinite;
            display: inline-block;
            width: 20px;
        }

        @keyframes thinking {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        function AgentGPTApp() {
            const [task, setTask] = useState('');
            const [apiKey, setApiKey] = useState('');
            const [thinking, setThinking] = useState(false);
            const [messages, setMessages] = useState([]);
            const [status, setStatus] = useState('idle');
            const [error, setError] = useState('');
            const messagesEndRef = useRef(null);
            const inputRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const addMessage = (role, content) => {
                setMessages(prev => [...prev, { role, content, timestamp: new Date().toISOString() }]);
            };

            const callGPT = async (systemPrompt, userPrompt) => {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4",
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: userPrompt }
                        ]
                    })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                return data.choices[0].message.content;
            };

            const executeStep = async (step, context) => {
                addMessage('agent', `🤔 Thinking about how to execute: ${step}`);
                
                try {
                    const execution = await callGPT(
                        "You are an autonomous AI agent. Execute the given step and provide detailed results. If you need any user input or clarification, explicitly state 'NEED_INPUT: your question'. Always think step by step and explain your thought process.",
                        `Current step to execute: ${step}\nContext: ${context}\nThink through this step carefully and explain your process.`
                    );

                    if (execution.includes('NEED_INPUT:')) {
                        addMessage('agent', '❓ I need some information from you:');
                        addMessage('agent', execution.split('NEED_INPUT:')[1].trim());
                        setStatus('waiting_input');
                        return { needsInput: true, question: execution.split('NEED_INPUT:')[1].trim() };
                    }

                    addMessage('agent', `✓ ${execution}`);
                    return { needsInput: false, result: execution };
                } catch (err) {
                    addMessage('error', `❌ Error executing step: ${err.message}`);
                    throw err;
                }
            };

            const handleSubmit = async () => {
                if (thinking) return;
                setThinking(true);
                setStatus('working');
                setMessages([]);
                setError('');

                try {
                    addMessage('agent', '🔍 Analyzing the task and creating a plan...');
                    
                    const taskAnalysis = await callGPT(
                        "You are an autonomous task planning AI. Analyze the given task and break it down into clear, specific steps. Think carefully about dependencies and potential challenges.",
                        `Task: ${task}\nCreate a detailed plan with numbered steps. Consider edge cases and potential challenges.`
                    );

                    addMessage('agent', '📋 Here\'s my plan:');
                    addMessage('agent', taskAnalysis);

                    const steps = taskAnalysis
                        .split('\n')
                        .filter(line => /^\d+\./.test(line))
                        .map(line => line.replace(/^\d+\.\s*/, '').trim());

                    let context = '';
                    for (let i = 0; i < steps.length; i++) {
                        addMessage('agent', `\n🔄 Starting step ${i + 1}/${steps.length}`);
                        
                        const result = await executeStep(steps[i], context);
                        if (result.needsInput) {
                            setThinking(false);
                            if (inputRef.current) inputRef.current.focus();
                            return;
                        }
                        
                        context += `\nStep ${i + 1} result: ${result.result}`;
                    }

                    addMessage('agent', '🎉 Task completed successfully!');
                    setStatus('completed');

                } catch (err) {
                    setError(err.message);
                    addMessage('error', `❌ Error: ${err.message}`);
                    setStatus('error');
                } finally {
                    setThinking(false);
                }
            };

            const handleUserInput = async (event) => {
                if (event.key !== 'Enter' || !event.target.value.trim()) return;
                
                const userResponse = event.target.value;
                event.target.value = '';
                
                addMessage('user', userResponse);
                setStatus('working');
                setThinking(true);

                try {
                    const continuation = await callGPT(
                        "You are an autonomous AI agent. Continue the task execution with the provided user input.",
                        `Previous context: ${messages.map(m => m.content).join('\n')}\nUser input: ${userResponse}\nContinue the task execution.`
                    );

                    addMessage('agent', continuation);
                    
                    if (!continuation.includes('NEED_INPUT:')) {
                        handleSubmit();
                    }
                } catch (err) {
                    setError(err.message);
                    setStatus('error');
                } finally {
                    setThinking(false);
                }
            };

            return (
                <div className="min-h-screen py-8">
                    <div className="container mx-auto px-4 max-w-3xl">
                        <div className="space-y-6">
                            <h1 className="text-4xl font-bold text-center mb-8 green-text">AgentGPT</h1>
                            
                            <div>
                                <label className="block text-sm font-medium mb-2 text-gray-300">OpenAI API Key</label>
                                <input
                                    type="password"
                                    value={apiKey}
                                    onChange={(e) => setApiKey(e.target.value)}
                                    placeholder="Enter your API key"
                                    className="w-full p-4 rounded-md chatgpt-input text-white placeholder-gray-500"
                                />
                            </div>
                            
                            <div className="relative">
                                <textarea
                                    value={task}
                                    onChange={(e) => setTask(e.target.value)}
                                    disabled={thinking}
                                    placeholder="Describe your task..."
                                    className="w-full p-4 pr-20 rounded-lg chatgpt-input text-white placeholder-gray-500 h-32 resize-none"
                                />
                                <button 
                                    onClick={handleSubmit}
                                    disabled={thinking || !task || !apiKey}
                                    className={`absolute right-3 bottom-3 p-2 px-4 rounded-md ${
                                        thinking || !task || !apiKey 
                                            ? 'bg-gray-600 cursor-not-allowed' 
                                            : 'green-button hover:bg-green-700'
                                    } text-white transition-colors duration-200`}
                                >
                                    {thinking ? '...' : '▶'}
                                </button>
                            </div>

                            {messages.length > 0 && (
                                <div className="result-block rounded-lg p-6 space-y-4">
                                    {messages.map((message, index) => (
                                        <div key={index} className={`message-block ${
                                            message.role === 'error' ? 'text-red-400' :
                                            message.role === 'user' ? 'text-blue-400' : 'text-gray-300'
                                        }`}>
                                            {message.content}
                                        </div>
                                    ))}
                                    <div ref={messagesEndRef} />
                                </div>
                            )}

                            {status === 'waiting_input' && (
                                <div className="relative">
                                    <input
                                        ref={inputRef}
                                        type="text"
                                        placeholder="Type your response and press Enter..."
                                        className="w-full p-4 rounded-md chatgpt-input text-white placeholder-gray-500"
                                        onKeyPress={handleUserInput}
                                    />
                                </div>
                            )}

                            <div className="mt-4 text-center text-sm text-gray-500">
                                {thinking && <span className="thinking-dots">Thinking</span>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<AgentGPTApp />, document.getElementById('root'));
    </script>
</body>
</html>
